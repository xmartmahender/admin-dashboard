rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated admin
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Admin collection - only admins can read/write their own data
    match /admins/{adminId} {
      allow read, write: if isAuthenticated() && request.auth.uid == adminId;
      allow create: if isAuthenticated(); // Allow initial admin creation
    }
    
    // Stories collection - only admins can write, everyone can read
    match /stories/{storyId} {
      allow read: if true; // Public read access for the main website
      allow write: if isAdmin(); // Only admins can create/update/delete
    }
    
    // Videos collection - only admins can write, everyone can read
    match /videos/{videoId} {
      allow read: if true; // Public read access for the main website
      allow write: if isAdmin(); // Only admins can create/update/delete
    }
    
    // Admin posts collection - only admins can write, everyone can read
    match /adminPosts/{postId} {
      allow read: if true; // Public read access for the main website
      allow write: if isAdmin(); // Only admins can create/update/delete
    }
    
    // User tracking collection - read/write for tracking user activity
    match /userTracking/{trackingId} {
      allow read, write: if true; // Allow user tracking for analytics
    }
    
    // Connected users collection - read/write for real-time user tracking
    match /connectedUsers/{userId} {
      allow read: if isAdmin(); // Only admins can see connected users
      allow write: if true; // Allow users to update their connection status
    }
    
    // User statistics collection - only admins can read
    match /userStatistics/{statId} {
      allow read: if isAdmin(); // Only admins can view statistics
      allow write: if true; // Allow automatic statistics updates
    }
    
    // Admin activity logs - only admins can read, system can write
    match /adminLogs/{logId} {
      allow read: if isAdmin(); // Only admins can view logs
      allow create: if isAdmin(); // Only admins can create logs
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
